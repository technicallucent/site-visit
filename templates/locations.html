{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Locations Management
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Add Location Form -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-plus me-2"></i>Add New Location
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="addLocationForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Location Name *</label>
                                        <input type="text" class="form-control" id="locationName" 
                                               placeholder="Enter location name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Description</label>
                                        <input type="text" class="form-control" id="locationDescription" 
                                               placeholder="Enter location description">
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-1"></i>Add Location
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Locations List -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>Existing Locations
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="locationsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Location Name</th>
                                            <th>Description</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for location in locations %}
                                        <tr id="location-{{ location.id }}">
                                            <td>{{ location.id }}</td>
                                            <td>{{ location.name }}</td>
                                            <td>{{ location.description or '-' }}</td>
                                            <td>{{ location.created_at.strftime('%b %d, %Y') }}</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm delete-location" 
                                                        data-location-id="{{ location.id }}"
                                                        data-location-name="{{ location.name }}">
                                                    <i class="fas fa-trash me-1"></i>Delete
                                                </button>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                No locations found. Add your first location above.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete location "<span id="locationNameToDelete"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteLocation">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add location form submission
    document.getElementById('addLocationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('locationName').value.trim();
        const description = document.getElementById('locationDescription').value.trim();
        
        if (!name) {
            alert('Please enter a location name');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';

        fetch('/locations/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Location added successfully!');
                location.reload(); // Reload to show new location
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding location. Please try again.');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Add Location';
        });
    });

    // Delete location functionality
    let locationToDelete = null;
    
    document.querySelectorAll('.delete-location').forEach(button => {
        button.addEventListener('click', function() {
            locationToDelete = this.dataset.locationId;
            const locationName = this.dataset.locationName;
            
            document.getElementById('locationNameToDelete').textContent = locationName;
            const modal = new bootstrap.Modal(document.getElementById('deleteLocationModal'));
            modal.show();
        });
    });

    document.getElementById('confirmDeleteLocation').addEventListener('click', function() {
        if (!locationToDelete) return;

        const deleteBtn = this;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';

        fetch(`/locations/${locationToDelete}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteLocationModal'));
            modal.hide();
            
            if (result.success) {
                alert('Location deleted successfully!');
                // Remove the row from table
                document.getElementById(`location-${locationToDelete}`).remove();
                
                // If no locations left, show message
                if (document.querySelectorAll('#locationsTable tbody tr').length === 1) {
                    document.querySelector('#locationsTable tbody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                No locations found. Add your first location above.
                            </td>
                        </tr>
                    `;
                }
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting location. Please try again.');
        })
        .finally(() => {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = 'Delete';
            locationToDelete = null;
        });
    });
});
</script>
{% endblock %}