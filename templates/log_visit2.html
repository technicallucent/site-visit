{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-plus-circle me-2"></i>Log New Site Visit
                    </h4>
                </div>
                <div class="p-2" style="background: linear-gradient(135deg, #79797a, #667575);">
                    <!-- Mobile Verification Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-mobile-alt me-2 text-primary"></i>Verify Client Mobile Number
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Mobile Number *</label>
                                    <input type="tel" class="form-control" id="mobileNumber" 
                                           placeholder="Enter 10-digit mobile number" maxlength="10" pattern="[0-9]{10}">
                                    <div class="form-text">Enter 10-digit mobile number without country code</div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary w-100" id="verifyMobile">
                                        <i class="fas fa-check me-1"></i>Verify
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Client Data Section -->
                    <div id="clientDataSection" style="display: none;">
                        <!-- Previous Visits -->
                        <div class="card mb-4" id="previousVisitsCard" style="display: none;">
                            <div class="card-header bg-warning">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-history me-2"></i>Previous Site Visits
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="previousVisitsList"></div>
                            </div>
                        </div>

                        <form id="visitForm">
                            <!-- Client Information Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="card-title mb-0">1. Client Data</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Client Name *</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Mobile Number *</label>
                                            <input type="tel" class="form-control" name="mobile" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Secondary Number</label>
                                            <input type="tel" class="form-control" name="secondary_number" maxlength="10">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Lead Source</label>
                                            <select class="form-select" name="lead_source">
                                                <option value="">Select lead source</option>
                                                <option value="Website">Website</option>
                                                <option value="Facebook">Facebook</option>
                                                <option value="Instagram">Instagram</option>
                                                <option value="Referral">Referral</option>
                                                <option value="Walk-in">Walk-in</option>
                                                <option value="Newspaper">Newspaper</option>
                                                <option value="Google Ads">Google Ads</option>
                                                <option value="Broker">Broker</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Lead Source Project</label>
                                            <input type="text" class="form-control" name="lead_source_project" placeholder="Project that generated lead">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Property Requirements Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">Property Requirements</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">BHK Requirement</label>
                                            <select class="form-select" name="bhk_requirement">
                                                <option value="">Select BHK requirement</option>
                                                <option value="1BHK">1BHK</option>
                                                <option value="2BHK">2BHK</option>
                                                <option value="3BHK">3BHK</option>
                                                <option value="4BHK">4BHK</option>
                                                <option value="4+BHK">4+BHK</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Budget</label>
                                            <select class="form-select" name="budget">
                                                <option value="">Select Budget</option>
                                                <option value="1 Cr to 2 Cr">1 Cr to 2 Cr</option>
                                                <option value="2 Cr to 3 Cr">2 Cr to 3 Cr</option>
                                                <option value="3 Cr to 5 Cr">3 Cr to 5 Cr</option>
                                                <option value="5 Cr to 8 Cr">5 Cr to 8 Cr</option>
                                                <option value="8 Cr to 12 Cr">8 Cr to 12 Cr</option>
                                                <option value="12 Cr to 20 Cr">12 Cr to 20 Cr</option>
                                                <option value="20 Cr to 30 Cr">20 Cr to 30 Cr</option>
                                                <option value="30 Cr+">30 Cr+</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Preferred Location</label>
                                            <input type="text" class="form-control" name="preferred_location" 
                                                   placeholder="Enter preferred location">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Current Location</label>
                                            <input type="text" class="form-control" name="current_location" 
                                                   placeholder="Enter current location">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Building Name</label>
                                            <input type="text" class="form-control" name="building_name" 
                                                   placeholder="Enter building name">
                                        </div>
                                 <div class="col-md-6">
    <label class="form-label">Preferred Projects</label>
    <select class="form-select select2" name="preferred_projects" multiple>
        {% for project in projects %}
            <option value="{{ project.id }}">{{ project.name }}</option>
        {% endfor %}
    </select>
    <div class="form-text">You can select multiple projects</div>
</div>

                                        <div class="col-12">
                                            <label class="form-label">Notes</label>
                                            <textarea class="form-control" name="notes" rows="3" 
                                                      placeholder="Enter any additional notes about client requirements"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Site Visit Data Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="card-title mb-0">2. Site Visit Data</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Visit Date *</label>
                                            <input type="date" class="form-control" name="visit_date" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Project *</label>
                                            <select class="form-select" name="project_id" required>
                                                <option value="">Select a project</option>
                                                {% for project in projects %}
                                                <option value="{{ project.id }}">{{ project.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                     <div class="col-md-6">
    <label class="form-label">Agents Involved</label>
    <select class="form-select select2" name="agents_involved" multiple>
        {% for user in users %}
        <option value="{{ user.id }}" {% if user.id == current_user.id %}selected{% endif %}>{{ user.name }}</option>
        {% endfor %}
    </select>
    <div class="form-text">Current user is automatically included</div>
</div>

                                        <div class="col-md-6 d-none">
                                            <label class="form-label">Telecallers Involved</label>
                                            <input type="text" class="form-control" value="None" name="telecallers_involved" 
                                                   placeholder="Enter telecaller names separated by commas">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Visit Notes</label>
                                            <textarea class="form-control" name="visit_notes" rows="3" 
                                                      placeholder="Enter notes about this specific site visit"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save Visit Log
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        $('.select2').select2({
            placeholder: "Select preferred projects",
            allowClear: true,
            width: '100%'
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default visit date to today
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="visit_date"]').value = today;
});

document.getElementById('verifyMobile').addEventListener('click', function() {
    const mobile = document.getElementById('mobileNumber').value.trim();
    
    if (!mobile || mobile.length !== 10 || !/^\d+$/.test(mobile)) {
        alert('Please enter a valid 10-digit mobile number');
        return;
    }

    const verifyBtn = this;
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';

    // Create form data for POST request
    const formData = new URLSearchParams();
    formData.append('mobile', mobile);

    fetch('/log-visit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Verification response:', data);
        
        const clientSection = document.getElementById('clientDataSection');
        const previousVisitsCard = document.getElementById('previousVisitsCard');
        const previousVisitsList = document.getElementById('previousVisitsList');
        
        clientSection.style.display = 'block';
        document.querySelector('input[name="mobile"]').value = mobile;

        if (data.exists) {
            console.log('Client exists, filling form...');
            // Fill form with existing client data
            const client = data.client;
            
            // Fill basic fields
            document.querySelector('input[name="name"]').value = client.name || '';
            document.querySelector('input[name="email"]').value = client.email || '';
            document.querySelector('input[name="secondary_number"]').value = client.secondary_number || '';
            document.querySelector('input[name="lead_source_project"]').value = client.lead_source_project || '';
            document.querySelector('input[name="preferred_location"]').value = client.preferred_location || '';
            document.querySelector('input[name="current_location"]').value = client.current_location || '';
            document.querySelector('input[name="building_name"]').value = client.building_name || '';
            document.querySelector('textarea[name="notes"]').value = client.notes || '';
            
            // Fill select fields
            if (client.lead_source) {
                document.querySelector('select[name="lead_source"]').value = client.lead_source;
            }
            if (client.bhk_requirement) {
                document.querySelector('select[name="bhk_requirement"]').value = client.bhk_requirement;
            }
            if (client.budget) {
                document.querySelector('select[name="budget"]').value = client.budget;
            }
            
            // Fill preferred projects (multiple select)
            if (client.preferred_projects) {
                try {
                    const projectIds = JSON.parse(client.preferred_projects);
                    const projectsSelect = document.querySelector('select[name="preferred_projects"]');
                    // Clear previous selections
                    Array.from(projectsSelect.options).forEach(option => {
                        option.selected = false;
                    });
                    // Select the projects
                    projectIds.forEach(projectId => {
                        const option = projectsSelect.querySelector(`option[value="${projectId}"]`);
                        if (option) option.selected = true;
                    });
                } catch (e) {
                    console.error('Error parsing preferred projects:', e);
                }
            }

            // Show previous visits
            if (data.previous_visits && data.previous_visits.length > 0) {
                previousVisitsCard.style.display = 'block';
                previousVisitsList.innerHTML = data.previous_visits.map(visit => `
                    <div class="alert alert-info mb-2">
                        <strong>${visit.date}</strong> - ${visit.project} (${visit.status})
                        ${visit.agents ? `<br><small>Agents: ${visit.agents}</small>` : ''}
                    </div>
                `).join('');
            } else {
                previousVisitsCard.style.display = 'none';
                previousVisitsList.innerHTML = '';
            }
        } else {
            console.log('New client, clearing form...');
            previousVisitsCard.style.display = 'none';
            previousVisitsList.innerHTML = '';
            // Clear form for new client (except mobile)
            document.getElementById('visitForm').reset();
            document.querySelector('input[name="mobile"]').value = mobile;
        }
        
        // Scroll to client section
        clientSection.scrollIntoView({ behavior: 'smooth' });
    })
    .catch(error => {
        console.error('Verification error:', error);
        alert('Error verifying mobile number. Please check the console for details and try again.');
    })
    .finally(() => {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Verify';
    });
});

document.getElementById('visitForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

    // Collect form data
    const formData = new FormData(this);
    const data = {
        mobile: document.querySelector('input[name="mobile"]').value
    };
    
    // Convert FormData to object - FIXED SELECTOR ISSUE
    formData.forEach((value, key) => {
        if (key === 'preferred_projects' || key === 'agents_involved') {
            // Handle multiple select fields - FIXED SELECTOR
            const selectElement = document.querySelector(`select[name="${key}"]`);
            const selectedOptions = Array.from(selectElement.selectedOptions);
            data[key] = selectedOptions.map(opt => opt.value);
        } else {
            data[key] = value;
        }
    });

    console.log("Sending data to save:", data);

    fetch('/save-visit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(result => {
        console.log("Save result:", result);
        if (result.success) {
            alert('Site visit logged successfully!');
            window.location.href = '/';
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving site visit. Please try again.');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Visit Log';
    });
});
</script>
{% endblock %}